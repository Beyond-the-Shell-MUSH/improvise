var Moo={};(function(a){var b=function(c,d){return c.indexOf(d,c.length-d.length)!==-1};Number.prototype.toHTML=function(){return'<span class="moo-num">'+this+"</span>"};String.prototype.toHTML=function(d){var e,c;if(b(this,"|err")){e=_.escape(this.slice(0,this.length-4));return'<span class="moo-err">'+e+"</span>"}else{if(b(this,"|obj")){e=_.escape(this.slice(0,this.length-4));c=_.escape(this.slice(0,this.length-4).slice(1));return'<a rel="object" data-object-number="'+c+'" class="moo-obj" href="/objects/'+c+'">'+e+"</a>"}else{if(b(this,"|int")){e=_.escape(this.slice(0,this.length-4));return'<span class="moo-num">'+e+"</span>"}else{if(b(this,"|float")){e=_.escape(this.slice(0,this.length-6));return'<span class="moo-num">'+e+"</span>"}else{if(b(this,"|str")){e=_.escape(this.slice(0,this.length-4));return'<span class="moo-str">'+(d?'"'+e+'"':e)+"</span>"}else{e=_.escape(this);return'<span class="moo-str">'+(d?'"'+e+'"':e)+"</span>"}}}}}};Array.prototype.toHTML=function(){return'<span class="moo-list">{ '+_.map(this,function(c){return c.toHTML(true)}).join(", ")+" }</span>"};Object.prototype.toHTML=function(){return'<span class="moo-map">[ '+_.map(this,function(d,c){return c.toHTML(true)+" -> "+d.toHTML(true)}).join(", ")+" ]</span>"};_.extend(a,{isString:function(c){return typeof(c)=="string"&&!(b(c,"|obj")||b(c,"|err"))},isObjectNumber:function(c){return typeof(c)=="string"&&b(c,"|obj")},isError:function(c){return typeof(c)=="string"&&b(c,"|err")},isBinary:function(c){return c===0||c===1},isValidPerms:function(c,d){return typeof(c)=="string"&&c.match("^["+d+"]*$")},isValidObj:function(c){return _.include(["this","none","any"],c)},isValidPrep:function(d){var c=["with","using","at","to","in front of","in","inside","into","on top of","on","onto","upon","out of","from inside","from","over","through","under","underneath","beneath","behind","beside","for","about","is","as","off","off of","none","any"];return _.include(c,d)},isValidCode:function(c){return _.isArray(c)&&_.all(c,a.isString)},isValidObjectNumberArray:function(c){return _.isArray(c)&&_.all(c,a.isObjectNumber)}});a.NestedModel=Backbone.Model.extend({initialize:function(c){delete this.attributes.toHTML},has:function(d){var c=this.get(d);return !(c===null||c===undefined)},get:function(c,e){e=e||{};var g=c.split("."),d=g.shift();var f=Backbone.Model.prototype.get.call(this,d,e);_.each(g,function(h){f=f!=undefined&&(h in f)?f[h]:undefined});return f},set:function(e,g,f){var d;if(_.isObject(e)){d=e;f=g}else{d={};d[e]=g}f=f||{};var c=_.inject(this.attributes,function(h,j,i){h[i]=_.clone(j);return h},{});delete c.toHTML;_.each(d,function(k,h){var m=h.split("."),i=m.shift();var l=c,j=i;_.each(m,function(n){if(!(j in l)){l[j]={}}l=l[j];j=n});l[j]=k});return Backbone.Model.prototype.set.call(this,c,f)}});a.Attribute=a.NestedModel.extend({validate:function(c){if(c&&"Value" in c&&(typeof(c.Value)!="object")){return"invalid attribute"}}});a.Value=a.NestedModel.extend({validate:function(c){if(c&&"Value" in c&&(typeof(c.Value)!="object")){return"invalid value"}if(c&&"Value" in c&&"clear" in c.Value&&!a.isBinary(c.Value.clear)){return"invalid value: `clear' must be 0 or 1"}}});a.Property=a.NestedModel.extend({validate:function(c){if(c&&"Property" in c&&(typeof(c.Property)!="object")){return"invalid property"}if(c&&"Property" in c&&"name" in c.Property&&!a.isString(c.Property.name)){return"invalid property: `name' must be a string"}if(c&&"Property" in c&&"owner" in c.Property&&!a.isObjectNumber(c.Property.owner)){return"invalid property: `owner' must be an object number"}if(c&&"Property" in c&&"perms" in c.Property&&!a.isValidPerms(c.Property.perms,"rwc")){return"invalid property: `perms' must be in the set 'rwc'"}},isDenied:function(){return this.get("Meta.status")=="denied"}});a.Verb=a.NestedModel.extend({validate:function(c){if(c&&"Verb" in c&&(typeof(c.Verb)!="object")){return"invalid verb"}if(c&&"Verb" in c&&"names" in c.Verb&&!a.isString(c.Verb.names)){return"invalid verb: `names' must be a string"}if(c&&"Verb" in c&&"owner" in c.Verb&&!a.isObjectNumber(c.Verb.owner)){return"invalid verb: `owner' must be an object number"}if(c&&"Verb" in c&&"perms" in c.Verb&&!a.isValidPerms(c.Verb.perms,"rwxd")){return"invalid verb: `perms' must be in the set 'rwxd'"}if(c&&"Verb" in c&&"dobj" in c.Verb&&!a.isValidObj(c.Verb.dobj)){return"invalid verb: `dobj' must be valid"}if(c&&"Verb" in c&&"prep" in c.Verb&&!a.isValidPrep(c.Verb.prep)){return"invalid verb: `prep' must be valid"}if(c&&"Verb" in c&&"iobj" in c.Verb&&!a.isValidObj(c.Verb.iobj)){return"invalid verb: `iobj' must be valid"}if(c&&"Verb" in c&&"code" in c.Verb&&!a.isValidCode(c.Verb.code)){return"invalid verb: `code' must be an array of strings"}},isDenied:function(){return this.get("Meta.status")=="denied"}});a.Attributes=Backbone.Collection.extend({model:a.Attribute});a.Values=Backbone.Collection.extend({model:a.Value});a.Properties=Backbone.Collection.extend({model:a.Property});a.Verbs=Backbone.Collection.extend({model:a.Verb});a.Object=Backbone.Model.extend({urlRoot:"///objects",initialize:function(){this.attributez=new a.Attributes;this.attributez.url=this.url()+"/attributes";this.values=new a.Values;this.values.url=this.url()+"/values";this.properties=new a.Properties;this.properties.url=this.url()+"/properties";this.verbs=new a.Verbs;this.verbs.url=this.url()+"/verbs";this.parse(this.attributes)},validate:function(c){var d,e;if((d=this.attributez.get("player"))&&!a.isBinary(d.get("Value.value"))){return"invalid attribute: `player' must be 0 or 1"}if((d=this.attributez.get("parents"))&&!a.isValidObjectNumberArray(d.get("Value.value"))){return"invalid attribute: `parents' must be an array of object numbers"}if((e=this.values.get("name"))&&!a.isString(e.get("Value.value"))){return"invalid value: `name' must be a string"}if((e=this.values.get("owner"))&&!a.isObjectNumber(e.get("Value.value"))){return"invalid value: `owner' must be an object number"}if((e=this.values.get("location"))&&!a.isObjectNumber(e.get("Value.value"))){return"invalid value: `location' must be an object number"}if((e=this.values.get("contents"))&&!a.isValidObjectNumberArray(e.get("Value.value"))){return"invalid value: `contents' must be an array of object numbers"}if((e=this.values.get("programmer"))&&!a.isBinary(e.get("Value.value"))){return"invalid value: `programmer' must be 0 or 1"}if((e=this.values.get("wizard"))&&!a.isBinary(e.get("Value.value"))){return"invalid value: `wizard' must be 0 or 1"}if((e=this.values.get("r"))&&!a.isBinary(e.get("Value.value"))){return"invalid value: `r' must be 0 or 1"}if((e=this.values.get("w"))&&!a.isBinary(e.get("Value.value"))){return"invalid value: `w' must be 0 or 1"}if((e=this.values.get("f"))&&!a.isBinary(e.get("Value.value"))){return"invalid value: `f' must be 0 or 1"}},parse:function(d){var h=function(i,l,j){l.id=j;i.push(l);return i};var f=d.Attributes;delete d.Attributes;this.attributez.reset(_.chain(f).reduce(h,[]).value());var c=d.Values;delete d.Values;this.values.reset(_.chain(c).reduce(h,[]).value());var e=d.Properties;delete d.Properties;this.properties.reset(_.chain(e).reduce(h,[]).value());var g=d.Verbs;delete d.Verbs;this.verbs.reset(_.chain(g).reduce(h,[]).value());return d},fetch:function(e){e=e?_.clone(e):{};var d=this;var c=e.error;e.error=function(f,g){f.httpResponseStatus=g.status;if(c){c(f,g)}};return Backbone.Model.prototype.fetch.call(this,e)},failed:function(){return this.httpResponseStatus>=300},isNotFound:function(){return this.httpResponseStatus==404},isDenied:function(){return this.httpResponseStatus==403},toJSON:function(){var c=function(d,f,e){d[f.id]=f;delete f.id;return d};return{Attributes:_.chain(this.attributez.toJSON()).reduce(c,{}).value(),Values:_.chain(this.values.toJSON()).reduce(c,{}).value(),Properties:this.properties.toJSON(),Verbs:this.verbs.toJSON()}}});a.Objects=Backbone.Collection.extend({model:a.Object,url:"///objects"});$.widget("moo.simpleObjectPanel",{options:{object:null,template:'<div class="simple-object-panel"><div class="row-fluid"><div class="span12"><h1><% if (object.isNotFound()) { %><em>Not Found</em><% } else if (object.isDenied()) { %><em>Request Denied</em><% } else if (object.failed()) { %><em>Request Failed</em><% } else { %><%= object.values.get("name").get("Value.value").toHTML() %><% } %><% if ((p = object.attributez.get("player")) && p.get("Value.value")) { %> <small class="player-flag">player</small><% } %><% if ((p = object.values.get("programmer")) && p.get("Value.value")) { %> <small class="programmer-flag">programmer</small><% } %><% if ((p = object.values.get("wizard")) && p.get("Value.value")) { %> <small class="wizard-flag">wizard</small><% } %><% if ((v = object.values.get("r")) && v.get("Value.value")) { %> <small class="read-flag">R</small><% } %><% if ((v = object.values.get("w")) && v.get("Value.value")) { %> <small class="write-flag">W</small><% } %><% if ((v = object.values.get("f")) && v.get("Value.value")) { %> <small class="fertile-flag">F</small><% } %><% if ((p = object.attributez.get("parents")) && (p = p.get("Value.value")) && p.length > 0) { %>  <small class="parents"><%= p.toHTML(true) %></small><% } %></h1></div></div><div class="row-fluid"><div class="span4"><h2>Values</h2><table class="table table-condensed values"><tbody><% _.each(object.values.models, function(value) {var v = value.get("Value.value");if (v !== undefined) { %><tr><td rowspan="2" width="5%">&bull;</td><td><strong><%= value.get("id") %></strong></td></tr><tr><td class="ellipsis"><%= v.toHTML(true) %></td></tr><% } else { %><tr><td rowspan="2" width="5%">&bull;</td><td><strong><%= value.get("id") %></strong></td></tr><tr><td><em>denied</em></td></tr><% }}); %></tbody></table></div><div class="span4"><h2>Property Definitions</h2><table class="table table-condensed properties"><tbody><% _.each(object.properties.models, function(property) {if (!property.isDenied()) { %><tr class="property"><td rowspan="3" width="5%">&bull;</td><td colspan="2" class="name"><strong><%= property.get("Property.name").toHTML() %></strong></td></tr><tr class="property"><td><%= property.get("Property.owner").toHTML() %></td><td><%= property.get("Property.perms").toHTML() %></td></tr><tr class="property"><td colspan="2" class="ellipsis"><%= property.get("Property.value").toHTML() %></td></tr><% } else { %><tr class="property"><td width="5%">&bull;</td><td colspan="2"><em>denied</em></td></tr><% }}); %></tbody></table></div><div class="span4"><h2>Verb Definitions</h2><table class="table table-condensed verbs"><tbody><% _.each(object.verbs.models, function(verb) {if (!verb.isDenied()) { %><tr class="verb"><td rowspan="3" width="5%">&bull;</td><td colspan="5" class="names"><strong><%= verb.get("Verb.names").toHTML() %></strong></td></tr><tr class="verb"><td><%= verb.get("Verb.owner").toHTML() %></td><td><%= verb.get("Verb.perms").toHTML() %></td><td><%= verb.get("Verb.dobj").toHTML() %></td><td><%= verb.get("Verb.prep").toHTML() %></td><td><%= verb.get("Verb.iobj").toHTML() %></td></tr><tr class="verb"><td colspan="5" class="ellipsis"><%= verb.get("Verb.code").toHTML() %></td></tr><% } else { %><tr class="verb"><td width="5%">&bull;</td><td colspan="5"><em>denied</em></td></tr><% }}); %></tbody></table></div></div></div>'},_setOption:function(c,d){switch(c){case"object":this.options.object=d;this._jamba();break;case"template":this.options.template=d;this._jamba();break}},_jamba:function(){if(this.options.object){var c=_.template(this.options.template);this.element.html(c({object:this.options.object}))}},_create:function(){},destroy:function(){this.element.html("")}})})(Moo);